<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Gestor de JSON (carpeta /data)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    h1 { margin-bottom: 8px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #f5f5f5; text-align: left; }
    .muted { color: #666; font-size: 12px; }
    .btn { cursor: pointer; padding: 6px 10px; border: 1px solid #ccc; background: #fafafa; border-radius: 6px; }
    .btn:hover { background: #f0f0f0; }
    .danger { border-color: #e66; }
  </style>
</head>
<body>
  <h1>Gestor de JSON</h1>
  <div class="muted">Carpeta: <code>/data</code></div>

  <section style="margin-top: 16px;">
    <h3>Subir / Reemplazar</h3>
    <div class="row">
      <input type="file" id="fileInput" accept=".json" />
      <input type="text" id="nameInput" placeholder="(opcional) forzar nombre: ejemplo.json" />
      <button class="btn" id="btnUpload">Subir</button>
    </div>
    <div id="uploadMsg" class="muted" style="margin-top:6px;"></div>
  </section>

  <section style="margin-top: 24px;">
    <h3>Archivos en /data</h3>
    <button class="btn" id="btnRefresh">Actualizar lista</button>
    <table id="filesTable">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Tamaño</th>
          <th>Modificado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="listMsg" class="muted" style="margin-top:6px;"></div>
  </section>

  <script>
    const $ = sel => document.querySelector(sel);
    const formatBytes = (n) => {
      if (n < 1024) return n + ' B';
      const kb = n / 1024;
      if (kb < 1024) return kb.toFixed(1) + ' KB';
      const mb = kb / 1024;
      return mb.toFixed(1) + ' MB';
    };
    const formatDate = (ms) => new Date(ms).toLocaleString();

    async function fetchList() {
      $('#listMsg').textContent = 'Cargando...';
      try {
        const res = await fetch('/api/files');
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Error al listar');
        renderTable(data.files);
        $('#listMsg').textContent = `${data.files.length} archivo(s)`;
      } catch (err) {
        console.error(err);
        $('#listMsg').textContent = 'Error listando archivos';
      }
    }

    function renderTable(files) {
      const tbody = $('#filesTable tbody');
      tbody.innerHTML = '';
      for (const f of files) {
        const tr = document.createElement('tr');

        const tdName = document.createElement('td');
        tdName.textContent = f.name;
        tr.appendChild(tdName);

        const tdSize = document.createElement('td');
        tdSize.textContent = formatBytes(f.size);
        tr.appendChild(tdSize);

        const tdMtime = document.createElement('td');
        tdMtime.textContent = formatDate(f.mtime);
        tr.appendChild(tdMtime);

        const tdActions = document.createElement('td');

        // Descargar
        const a = document.createElement('a');
        a.href = `/api/files/${encodeURIComponent(f.name)}`;
        a.textContent = 'Descargar';
        a.className = 'btn';
        a.setAttribute('download', f.name);
        tdActions.appendChild(a);

        // Espacio
        const space = document.createTextNode(' ');
        tdActions.appendChild(space);

        // Borrar
        const btnDel = document.createElement('button');
        btnDel.className = 'btn danger';
        btnDel.textContent = 'Borrar';
        btnDel.onclick = async () => {
          if (!confirm(`¿Borrar "${f.name}"?`)) return;
          try {
            const res = await fetch(`/api/files/${encodeURIComponent(f.name)}`, { method: 'DELETE' });
            const data = await res.json();
            if (!data.ok) throw new Error(data.error || 'No se pudo borrar');
            await fetchList();
          } catch (err) {
            alert('Error: ' + err.message);
          }
        };
        tdActions.appendChild(btnDel);

        tr.appendChild(tdActions);
        tbody.appendChild(tr);
      }
    }

    $('#btnRefresh').addEventListener('click', fetchList);

    $('#btnUpload').addEventListener('click', async () => {
      const file = $('#fileInput').files[0];
      const forcedName = $('#nameInput').value.trim();
      $('#uploadMsg').textContent = '';

      if (!file) {
        $('#uploadMsg').textContent = 'Selecciona un archivo .json';
        return;
      }
      if (!file.name.toLowerCase().endsWith('.json') && !forcedName.toLowerCase().endsWith('.json')) {
        $('#uploadMsg').textContent = 'El archivo debe ser .json';
        return;
      }

      const fd = new FormData();
      fd.append('file', file);

      const url = forcedName
        ? '/api/upload?name=' + encodeURIComponent(forcedName)
        : '/api/upload';

      try {
        const res = await fetch(url, { method: 'POST', body: fd });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Error al subir');
        $('#uploadMsg').textContent = `✔ Subido como ${data.name}`;
        $('#fileInput').value = '';
        $('#nameInput').value = '';
        await fetchList();
      } catch (err) {
        console.error(err);
        $('#uploadMsg').textContent = 'Error: ' + err.message;
      }
    });

    // Cargar listado inicial
    fetchList();
  </script>
</body>
</html>

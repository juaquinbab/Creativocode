<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Gestor de Archivos (carpeta /data)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    h1 { margin-bottom: 8px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 12px; }
    table { border-collapse: collapse; width: 100%; margin-top: 16px; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
    th { background: #f5f5f5; }
    button { cursor: pointer; padding: 6px 10px; border: 1px solid #ccc; background: #fff; }
    button:hover { background: #f0f0f0; }
    .muted { color: #666; font-size: 12px; }
  </style>
</head>
<body>
  <h1>Gestor de Archivos</h1>
  <div class="muted">Carpeta: <code>/data</code></div>

  <div class="row">
    <form id="uploadForm">
      <input type="file" name="file" id="fileInput" required />
      <button type="submit">Subir</button>
    </form>
    <button id="refreshBtn" type="button">Actualizar lista</button>
  </div>

  <table id="filesTable">
    <thead>
      <tr>
        <th>Archivo</th>
        <th>Tamaño (bytes)</th>
        <th>Modificado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const tbody = document.querySelector('#filesTable tbody');
    const refreshBtn = document.getElementById('refreshBtn');
    const uploadForm = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');

    async function loadFiles() {
      tbody.innerHTML = '<tr><td colspan="4">Cargando...</td></tr>';
      try {
        const res = await fetch('/api/files');
        const files = await res.json();
        if (!Array.isArray(files)) throw new Error('Respuesta inesperada');

        if (files.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4">No hay archivos</td></tr>';
          return;
        }

        tbody.innerHTML = '';
        for (const f of files) {
          const tr = document.createElement('tr');

          const nameTd = document.createElement('td');
          nameTd.textContent = f.name;

          const sizeTd = document.createElement('td');
          sizeTd.textContent = f.size;

          const dateTd = document.createElement('td');
          const d = new Date(f.mtime);
          dateTd.textContent = d.toLocaleString();

          const actionsTd = document.createElement('td');

          // Descargar
          const a = document.createElement('a');
          a.href = '/api/files/' + encodeURIComponent(f.name);
          a.textContent = 'Descargar';
          a.style.marginRight = '8px';

          // Borrar
          const delBtn = document.createElement('button');
          delBtn.textContent = 'Borrar';
          delBtn.onclick = async () => {
            if (!confirm(`¿Borrar "${f.name}"?`)) return;
            const resp = await fetch('/api/files/' + encodeURIComponent(f.name), { method: 'DELETE' });
            if (resp.ok) {
              loadFiles();
            } else {
              const err = await resp.json().catch(() => ({}));
              alert('No se pudo borrar: ' + (err.error || resp.statusText));
            }
          };

          actionsTd.appendChild(a);
          actionsTd.appendChild(delBtn);

          tr.appendChild(nameTd);
          tr.appendChild(sizeTd);
          tr.appendChild(dateTd);
          tr.appendChild(actionsTd);
          tbody.appendChild(tr);
        }
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="4">Error cargando archivos</td></tr>';
      }
    }

    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = fileInput.files[0];
      if (!file) return;
      const fd = new FormData();
      fd.append('file', file);
      try {
        const resp = await fetch('/api/upload', { method: 'POST', body: fd });
        const json = await resp.json();
        if (!resp.ok) throw new Error(json.error || 'Error al subir');
        fileInput.value = '';
        loadFiles();
      } catch (err) {
        alert(err.message);
      }
    });

    refreshBtn.addEventListener('click', loadFiles);

    // Cargar lista al inicio
    loadFiles();
  </script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Gestor JSON (simple)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background:#f5f5f5; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin: 8px 0; }
    code { background:#f3f3f3; padding:2px 6px; border-radius:4px; }
    .right { text-align:right; white-space:nowrap; }
    pre { white-space: pre-wrap; word-break: break-word; background:#f9f9f9; padding:8px; border:1px solid #eee; }
  </style>
</head>
<body>
  <h1>Gestor JSON</h1>
  <div class="row">
    <input id="file" type="file" accept=".json,application/json">
    <button id="btnUpload">Subir</button>
    <span id="msg"></span>
  </div>

  <button id="btnReload">Actualizar</button>
  <table>
    <thead><tr><th>Nombre</th><th class="right">Tamaño</th><th>Fecha</th><th>Acciones</th></tr></thead>
    <tbody id="tbody"><tr><td colspan="4">Cargando…</td></tr></tbody>
  </table>

  <h3>Vista rápida</h3>
  <pre id="viewer">{ Selecciona “Ver” en un archivo }</pre>

  <script>
    const tbody = document.getElementById("tbody");
    const btnReload = document.getElementById("btnReload");
    const btnUpload = document.getElementById("btnUpload");
    const inpFile = document.getElementById("file");
    const msg = document.getElementById("msg");
    const viewer = document.getElementById("viewer");

    const fmtBytes = n => {
      if (n === 0) return "0 B";
      const k = 1024, sizes = ["B","KB","MB","GB"];
      const i = Math.floor(Math.log(n)/Math.log(k));
      return (n/Math.pow(k,i)).toFixed(1) + " " + sizes[i];
    };
    const fmtDate = ms => new Date(ms).toLocaleString();

    async function loadList() {
      tbody.innerHTML = `<tr><td colspan="4">Cargando…</td></tr>`;
      try {
        const r = await fetch("/api/files");
        const { files=[] } = await r.json();
        if (!files.length) {
          tbody.innerHTML = `<tr><td colspan="4">No hay archivos</td></tr>`;
          return;
        }
        tbody.innerHTML = files.map(f => `
          <tr>
            <td><code>${f.name}</code></td>
            <td class="right">${fmtBytes(f.size)}</td>
            <td>${fmtDate(f.mtime)}</td>
            <td>
              <button onclick="ver('${encodeURIComponent(f.name)}')">Ver</button>
              <button onclick="descargar('${encodeURIComponent(f.name)}')">Descargar</button>
              <button onclick="borrar('${encodeURIComponent(f.name)}')">Borrar</button>
            </td>
          </tr>`).join("");
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="4">Error al listar</td></tr>`;
      }
    }

    async function ver(enc) {
      viewer.textContent = "Cargando…";
      try {
        const r = await fetch(`/api/files/${enc}`);
        const t = await r.text();
        try { viewer.textContent = JSON.stringify(JSON.parse(t), null, 2); }
        catch { viewer.textContent = t; }
      } catch {
        viewer.textContent = "No se pudo leer el archivo.";
      }
    }

    function descargar(enc) {
      window.location.href = `/api/files/${enc}/download`;
    }

    async function borrar(enc) {
      if (!confirm("¿Borrar este archivo?")) return;
      const r = await fetch(`/api/files/${enc}`, { method: "DELETE" });
      if (r.ok) { await loadList(); }
      else { alert("No se pudo borrar"); }
    }

    btnUpload.onclick = async () => {
      const f = inpFile.files?.[0];
      if (!f) return alert("Selecciona un .json");
      msg.textContent = "Subiendo…";
      const fd = new FormData();
      fd.append("file", f);
      try {
        const r = await fetch("/api/upload", { method: "POST", body: fd });
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || "error");
        msg.textContent = `OK: ${data.savedAs}`;
        inpFile.value = "";
        await loadList();
      } catch (e) {
        msg.textContent = "Error al subir";
      } finally {
        setTimeout(()=> msg.textContent="", 2500);
      }
    };

    btnReload.onclick = loadList;
    loadList();
  </script>
</body>
</html>

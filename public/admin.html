<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Gestor de Archivos</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <header class="bg-white border-b sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <h1 class="text-2xl font-semibold text-gray-800">Gestor de Archivos</h1>
      <div class="flex gap-2 items-center w-full md:w-auto">
        <input id="search" type="text" placeholder="Buscar cliente…" class="w-full md:w-80 px-3 py-2 border rounded-md focus:outline-none focus:ring focus:ring-blue-200" />
        <button id="btnRefreshAll" class="px-3 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Actualizar</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <div id="status" class="text-sm text-gray-500 mb-3"></div>
    <div id="clientes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </main>

  <template id="cardTemplate">
    <div class="bg-white rounded-lg shadow border border-gray-200 flex flex-col">
      <div class="p-4 border-b flex items-center justify-between">
        <div>
          <h3 class="text-lg font-medium text-gray-900 cliente-title"></h3>
          <p class="text-xs text-gray-500 files-count"></p>
        </div>
        <button class="toggle-btn px-3 py-1.5 text-sm bg-gray-100 rounded-md hover:bg-gray-200">Abrir</button>
      </div>
      <div class="content hidden">
        <div class="p-4 space-y-3">
          <input type="file" class="file-input block w-full text-sm border rounded-md p-2" multiple>
          <div class="flex flex-wrap gap-2 items-center">
            <button class="btn-upload px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Subir</button>
            <button class="btn-download px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Descargar todo</button>
            <button class="btn-delete px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Eliminar seleccionados</button>
            <button class="btn-reload px-3 py-2 bg-gray-100 rounded-md hover:bg-gray-200">Refrescar</button>
            <label class="ml-auto inline-flex items-center gap-2 text-sm text-gray-600">
              <input type="checkbox" class="toggle-select-all"> Seleccionar todo
            </label>
          </div>
          <ul class="file-list divide-y text-sm text-gray-700 max-h-64 overflow-auto"></ul>
        </div>
      </div>
    </div>
  </template>

  <script>
    const elClientes = document.getElementById('clientes');
    const elStatus = document.getElementById('status');
    const tpl = document.getElementById('cardTemplate');
    const elSearch = document.getElementById('search');
    const btnRefreshAll = document.getElementById('btnRefreshAll');

    async function fetchJSON(url, opts) {
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    }

    function createCard({ cliente, filesCount }) {
      const node = tpl.content.cloneNode(true);
      const card = node.querySelector('.bg-white');
      const title = node.querySelector('.cliente-title');
      const count = node.querySelector('.files-count');
      const btnToggle = node.querySelector('.toggle-btn');
      const content = node.querySelector('.content');

      const fileInput = node.querySelector('.file-input');
      const btnUpload = node.querySelector('.btn-upload');
      const btnDownload = node.querySelector('.btn-download');
      const btnDelete = node.querySelector('.btn-delete');
      const btnReload = node.querySelector('.btn-reload');
      const list = node.querySelector('.file-list');
      const toggleAll = node.querySelector('.toggle-select-all');

      title.textContent = cliente + ' / salachat';
      count.textContent = `${filesCount ?? 0} archivo(s)`;
      card.dataset.cliente = cliente;

      btnToggle.addEventListener('click', () => {
        content.classList.toggle('hidden');
        btnToggle.textContent = content.classList.contains('hidden') ? 'Abrir' : 'Cerrar';
        if (!content.classList.contains('hidden')) loadFiles(cliente, list, count, toggleAll);
      });

      btnReload.addEventListener('click', () => loadFiles(cliente, list, count, toggleAll));

      btnDownload.addEventListener('click', () => {
        window.location.href = `/api/${encodeURIComponent(cliente)}/download`;
      });

      btnUpload.addEventListener('click', async () => {
        const files = fileInput.files;
        if (!files || !files.length) return;
        const fd = new FormData();
        for (const f of files) fd.append('files', f);
        await fetch(`/api/${encodeURIComponent(cliente)}/upload`, { method: 'POST', body: fd })
          .then(r => r.json()).catch(() => ({}));
        fileInput.value = '';
        await loadFiles(cliente, list, count, toggleAll);
      });

      btnDelete.addEventListener('click', async () => {
        const selected = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(i => i.value);
        if (selected.length === 0) return;
        await fetch(`/api/${encodeURIComponent(cliente)}/delete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ files: selected })
        }).then(r => r.json()).catch(() => ({}));
        await loadFiles(cliente, list, count, toggleAll);
      });

      toggleAll.addEventListener('change', () => {
        const checks = list.querySelectorAll('input[type="checkbox"]');
        checks.forEach(ch => ch.checked = toggleAll.checked);
      });

      return node;
    }

    async function loadClients() {
      elStatus.textContent = 'Cargando clientes…';
      elClientes.innerHTML = '';
      try {
        const data = await fetchJSON('/api/clients');
        const q = elSearch.value.trim().toLowerCase();
        const filtered = (data || []).filter(c => !q || c.cliente.toLowerCase().includes(q));
        if (filtered.length === 0) {
          elClientes.innerHTML = '<div class="text-gray-500">No se encontraron clientes con carpeta <code>salachat</code>.</div>';
        } else {
          const frag = document.createDocumentFragment();
          for (const c of filtered) frag.appendChild(createCard(c));
          elClientes.appendChild(frag);
        }
        elStatus.textContent = `${filtered.length} cliente(s)`;
      } catch {
        elStatus.textContent = 'No se pudieron cargar los clientes';
      }
    }

    async function loadFiles(cliente, listEl, countEl, toggleAll) {
      listEl.innerHTML = '<li class="p-2 text-gray-500">Cargando…</li>';
      try {
        const files = await fetchJSON(`/api/${encodeURIComponent(cliente)}/files`);
        listEl.innerHTML = '';
        if (!files || !files.length) {
          listEl.innerHTML = '<li class="p-2 text-gray-500">Sin archivos</li>';
          countEl.textContent = '0 archivo(s)';
          return;
        }
        const frag = document.createDocumentFragment();
        for (const f of files) {
          const li = document.createElement('li');
          li.className = 'flex items-center gap-2 p-2';
          li.innerHTML = `<input type="checkbox" value="${f}"><span class="truncate">${f}</span>`;
          frag.appendChild(li);
        }
        listEl.appendChild(frag);
        countEl.textContent = `${files.length} archivo(s)`;
        toggleAll.checked = false;
      } catch {
        listEl.innerHTML = '<li class="p-2 text-red-600">Error al cargar archivos</li>';
      }
    }

    elSearch.addEventListener('input', loadClients);
    btnRefreshAll.addEventListener('click', loadClients);

    // Inicial
    loadClients();
  </script>
</body>
</html>

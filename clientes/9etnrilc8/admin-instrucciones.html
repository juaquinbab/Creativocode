<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lugar de entrenamiento IA</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light only" />
  <style>
    /* Mejora del arrastre */
    .dragging { opacity: .6; }
    .drop-target { outline: 2px dashed #cbd5e1; outline-offset: 2px; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-white to-slate-50 text-slate-800">
  <!-- Header -->
  <header class="sticky top-0 z-10 backdrop-blur bg-white/75 border-b border-slate-200">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center gap-3">
      <div class="shrink-0 rounded-xl bg-slate-900 text-white p-2">
        <svg viewBox="0 0 24 24" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M7 7l-4 4 4 4M17 7l4 4-4 4M10 21l4-18"></path>
        </svg>
      </div>
      <div class="flex-1">
        <h1 class="text-lg font-semibold leading-tight">Lugar de entrenamiento IA</h1>
        <p class="text-sm text-slate-500">Edita, reordena y sincroniza tu lista de <em>instrucciones</em>.</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="btn-recargar" class="inline-flex items-center gap-2 rounded-xl px-3 py-2 text-sm border shadow-sm transition border-slate-200 bg-white hover:bg-slate-50">
          <span class="inline-block">‚Üª</span> Recargar
        </button>
        <button id="btn-guardar" class="inline-flex items-center gap-2 rounded-xl px-3 py-2 text-sm border shadow-sm transition border-slate-900 bg-slate-900 text-white hover:bg-slate-800">
          <span class="inline-block">üíæ</span> Guardar
        </button>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-6 grid lg:grid-cols-3 gap-6">
    <!-- Panel izquierdo -->
    <section class="lg:col-span-1">
      <div class="rounded-2xl border border-slate-200 bg-white shadow-sm">
        <div class="p-4 border-b border-slate-100 flex items-center gap-2">
          <svg viewBox="0 0 24 24" class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 21l-4.35-4.35M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16z"/></svg>
          <input id="filtro" placeholder="Filtrar‚Ä¶" class="w-full outline-none text-sm bg-transparent"/>
        </div>
        <div class="p-4 space-y-3">
          <div>
            <label class="block text-xs text-slate-500 mb-1">Token de administrador (opcional)</label>
            <div class="relative">
              <svg viewBox="0 0 24 24" class="w-4 h-4 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M17 11V8a5 5 0 0 0-10 0v3m-2 0h14v9H5v-9z"/></svg>
              <input id="token" type="password" placeholder="x-admin-token" class="w-full pl-9 pr-3 py-2 rounded-xl border border-slate-200 bg-slate-50/60 focus:bg-white focus:ring-2 focus:ring-slate-200 outline-none"/>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <button id="btn-agregar" class="inline-flex items-center justify-center gap-2 rounded-xl px-3 py-2 text-sm border border-slate-200 bg-white hover:bg-slate-50 shadow-sm">Ôºã Agregar l√≠nea</button>
            <button id="btn-importar" class="inline-flex items-center justify-center gap-2 rounded-xl px-3 py-2 text-sm border border-slate-200 bg-white hover:bg-slate-50 shadow-sm">‚¨ÜÔ∏è Importar JSON</button>
            <input id="file-json" type="file" accept="application/json,.json" class="hidden"/>
            <button id="btn-exportar" class="inline-flex items-center justify-center gap-2 rounded-xl px-3 py-2 text-sm border border-slate-200 bg-white hover:bg-slate-50 shadow-sm col-span-2">‚¨áÔ∏è Exportar JSON</button>
          </div>

          <div class="flex items-center justify-between pt-1">
            <span class="text-sm text-slate-500" id="contador">0 l√≠neas</span>
            <button id="btn-toggle-json" class="text-xs text-slate-600 underline decoration-dotted hover:text-slate-900">Ocultar/Ver JSON</button>
          </div>
        </div>
      </div>

      <div id="toast" class="hidden mt-3 rounded-xl border p-3 text-sm"></div>
    </section>

    <!-- Panel derecho -->
    <section class="lg:col-span-2 space-y-6">
      <div class="rounded-2xl border border-slate-200 bg-white shadow-sm">
        <div class="p-4 border-b border-slate-100 flex items-center justify-between">
          <h2 class="font-medium">Lista de instrucciones</h2>
          <span class="text-xs text-slate-500">Arrastra para reordenar</span>
        </div>
        <ul id="lista" class="divide-y divide-slate-100"></ul>
      </div>

      <div id="panel-json" class="rounded-2xl border border-slate-200 bg-slate-900 text-slate-50 shadow-sm">
        <div class="p-3 border-b border-slate-800 flex items-center justify-between">
          <div class="inline-flex items-center gap-2"><span class="text-sm">Vista JSON</span></div>
          <div class="text-xs text-slate-400">Solo lectura ‚Ä¢ sincronizado</div>
        </div>
        <pre class="p-4 overflow-auto text-[13px]"><code id="raw">{ "instrucciones": [] }</code></pre>
      </div>
    </section>
  </main>

  <footer class="mx-auto max-w-6xl px-4 pb-10 pt-2 text-center text-xs text-slate-500">
    Ctrl/‚åò+S para guardar ‚Ä¢ Ctrl/‚åò+Enter para agregar l√≠nea
  </footer>

  <script>
    // --- Utilidades UI ---
    const $ = (sel) => document.querySelector(sel);
    const elLista = $("#lista");
    const elRaw = $("#raw");
    const elFiltro = $("#filtro");
    const elToken = $("#token");
    const elToast = $("#toast");
    const elPanelJSON = $("#panel-json");
    const elContador = $("#contador");
    const fileInput = $("#file-json");

    const basePath = `/${window.location.pathname.split('/')[1]}`;
    const API_URL = `${basePath}/api/instrucciones`;

    let instrucciones = [];
    let filtro = "";
    let showJSON = true;
    let saving = false;
    let loading = false;

    const hdr = () => {
      const h = {};
      const t = elToken.value.trim();
      if (t) h["x-admin-token"] = t;
      return h;
    };

    function setToast(type, msg) {
      elToast.className = "mt-3 rounded-xl border p-3 text-sm";
      if (type === "ok") {
        elToast.classList.add("border-emerald-200","bg-emerald-50","text-emerald-800");
      } else {
        elToast.classList.add("border-rose-200","bg-rose-50","text-rose-800");
      }
      elToast.textContent = msg;
      elToast.classList.remove("hidden");
      setTimeout(() => elToast.classList.add("hidden"), 3000);
    }

    function syncJSON() {
      elRaw.textContent = JSON.stringify({ instrucciones }, null, 2);
      elContador.textContent = `${instrucciones.length} ${instrucciones.length === 1 ? "l√≠nea" : "l√≠neas"}`;
    }

    function render() {
      elLista.innerHTML = "";
      const f = filtro.trim().toLowerCase();
      const data = !f ? instrucciones.map((t, i) => [i, t]) : instrucciones
        .map((t, i) => [i, t])
        .filter(([, t]) => t.toLowerCase().includes(f));

      if (data.length === 0) {
        const li = document.createElement("li");
        li.className = "p-6 text-sm text-slate-500";
        li.textContent = "No hay elementos que coincidan.";
        elLista.appendChild(li);
      } else {
        for (const [idx, texto] of data) {
          const li = document.createElement("li");
          li.className = "p-3 sm:p-4 flex flex-col sm:flex-row gap-3 sm:items-center bg-white hover:bg-slate-50/60 transition";
          li.draggable = true;
          li.dataset.index = idx;

          // arrastre
          li.addEventListener("dragstart", (e) => {
            li.classList.add("dragging");
            e.dataTransfer.setData("text/plain", String(idx));
          });
          li.addEventListener("dragend", () => li.classList.remove("dragging"));
          li.addEventListener("dragover", (e) => {
            e.preventDefault();
            li.classList.add("drop-target");
          });
          li.addEventListener("dragleave", () => li.classList.remove("drop-target"));
          li.addEventListener("drop", (e) => {
            e.preventDefault();
            li.classList.remove("drop-target");
            const from = Number(e.dataTransfer.getData("text/plain"));
            const to = Number(li.dataset.index);
            if (Number.isFinite(from) && Number.isFinite(to) && from !== to) {
              const arr = [...instrucciones];
              const [m] = arr.splice(from, 1);
              arr.splice(to, 0, m);
              instrucciones = arr;
              render();
            }
          });

          const badge = document.createElement("div");
          badge.className = "shrink-0 select-none text-xs text-slate-400 w-8 h-8 rounded-lg border border-slate-200 bg-slate-50/60 grid place-items-center";
          badge.textContent = idx + 1;

          const input = document.createElement("input");
          input.className = "flex-1 w-full rounded-xl border border-slate-200 bg-slate-50/60 focus:bg-white focus:ring-2 focus:ring-slate-200 outline-none px-3 py-2 text-sm";
          input.placeholder = "Escribe la instrucci√≥n‚Ä¶";
          input.value = texto;
          input.addEventListener("input", (e) => {
            instrucciones[idx] = e.target.value;
            syncJSON();
          });

          const btns = document.createElement("div");
          btns.className = "shrink-0 flex items-center gap-1";

          const bUp = document.createElement("button");
          bUp.title = "Subir";
          bUp.className = "rounded-lg p-2 border border-slate-200 hover:bg-slate-100";
          bUp.textContent = "‚Üë";
          bUp.onclick = () => move(idx, -1);

          const bDown = document.createElement("button");
          bDown.title = "Bajar";
          bDown.className = "rounded-lg p-2 border border-slate-200 hover:bg-slate-100";
          bDown.textContent = "‚Üì";
          bDown.onclick = () => move(idx, +1);

          const bDel = document.createElement("button");
          bDel.title = "Eliminar";
          bDel.className = "rounded-lg p-2 border border-rose-200 text-rose-600 hover:bg-rose-50";
          bDel.textContent = "‚úï";
          bDel.onclick = () => { instrucciones.splice(idx,1); render(); };

          btns.appendChild(bUp);
          btns.appendChild(bDown);
          btns.appendChild(bDel);

          li.appendChild(badge);
          li.appendChild(input);
          li.appendChild(btns);

          elLista.appendChild(li);
        }
      }
      syncJSON();
    }

    function addLinea(val="") {
      instrucciones.push(val);
      render();
    }

    function move(i, dir) {
      const j = i + dir;
      if (j < 0 || j >= instrucciones.length) return;
      [instrucciones[i], instrucciones[j]] = [instrucciones[j], instrucciones[i]];
      render();
    }

    // --- Eventos de UI ---
    $("#btn-agregar").onclick = () => addLinea("");
    $("#btn-recargar").onclick = cargar;
    $("#btn-guardar").onclick = guardar;
    $("#btn-exportar").onclick = () => {
      const blob = new Blob([JSON.stringify({ instrucciones }, null, 2)], { type: "application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "instrucciones.json"; a.click();
      URL.revokeObjectURL(url);
    };
    $("#btn-importar").onclick = () => fileInput.click();
    fileInput.onchange = (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const text = String(reader.result || "");
          const parsed = JSON.parse(text);
          if (!Array.isArray(parsed.instrucciones)) throw new Error("JSON debe contener { instrucciones: [] }");
          instrucciones = parsed.instrucciones.map(String);
          render();
          setToast("ok", "Importado desde JSON");
        } catch (err) {
          setToast("err", "Error importando: " + err.message);
        }
      };
      reader.readAsText(file);
      e.target.value = "";
    };

    $("#btn-toggle-json").onclick = () => {
      showJSON = !showJSON;
      elPanelJSON.style.display = showJSON ? "" : "none";
    };

    elFiltro.addEventListener("input", (e) => {
      filtro = e.target.value;
      render();
    });

    // Atajos de teclado
    window.addEventListener("keydown", (e) => {
      const k = e.key.toLowerCase();
      if ((e.ctrlKey || e.metaKey) && k === "s") {
        e.preventDefault();
        guardar();
      }
      if ((e.ctrlKey || e.metaKey) && k === "enter") {
        e.preventDefault();
        addLinea("");
      }
    });

    // --- Networking ---
    async function cargar() {
      if (loading) return;
      loading = true;
      try {
        const res = await fetch(API_URL, { headers: hdr() });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!Array.isArray(data.instrucciones)) throw new Error("Respuesta inv√°lida");
        instrucciones = data.instrucciones.map(String);
        setToast("ok", "Instrucciones cargadas");
        render();
      } catch (e) {
        setToast("err", "Error cargando: " + e.message);
        console.error(e);
      } finally {
        loading = false;
      }
    }

    async function guardar() {
      if (saving) return;
      saving = true;
      try {
        const res = await fetch(API_URL, {
          method: "PUT",
          headers: { "Content-Type": "application/json", ...hdr() },
          body: JSON.stringify({ instrucciones: instrucciones.map(String) })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const out = await res.json();
        setToast(out.ok ? "ok" : "err", out.ok ? "Guardado ‚úÖ" : "No se pudo guardar");
      } catch (e) {
        setToast("err", "Error guardando: " + e.message);
        console.error(e);
      } finally {
        saving = false;
      }
    }

    // Autocargar al abrir
    cargar();
  </script>
</body>
</html>
